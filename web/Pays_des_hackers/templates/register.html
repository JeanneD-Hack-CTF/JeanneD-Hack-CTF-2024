<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Page d'inscription</title>
  <!-- Ajoutez le lien CDN de Bootstrap ci-dessous ou utilisez une version téléchargée localement -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="text-center">Inscription</h3>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}" role="alert">
              {{ message }}
            </div>
            {% endfor %}
            {% endif %}
          {% endwith %}
          
          <form action="" method="post">
            <div id="first-step">
                <div class="mb-3">
                    <label for="username" class="form-label">Nom d'utilisateur</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                  </div>
                  <div class="mb-3">
                    <label for="password" class="form-label">Mot de passe</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                  </div>
            </div>

          <div id="second-step" style="visibility: hidden; height: 0;">
            <div class="mb-3">
                <label for="posture" class="form-label">Êtes vous plutôt attaque ou défense ?</label>
                <select name="posture" id="posture-select" class="form-control">
                <option value="victim">-- Faites votre choix --</option>
                <option value="attack">Attaque</option>
                <option value="defense">Défense</option>
                <option value="victim">Victime</option>
                </select>
            </div>
        
            <div class="mb-3">
                <label for="master" class="form-label">Quel est votre niveau de maîtrise ?</label>
                <select name="master" id="master-select" class="form-control">
                <option value="low">-- Faites votre choix --</option>
                <option value="high">Je vois le monde en BYTEs</option>
                <option value="medium">J'ai déjà utilisé Burp Suite</option>
                <option value="low">Je fais mes TPs avec ChatGPT...</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="report" class="form-label">Comment rédigez vous vos rapports ?</label>
                <select name="report" id="report-select" class="form-control">
                <option value="beginner">-- Faites votre choix --</option>
                <option value="advanced">LaTeX</option>
                <option value="learner">Markdown</option>
                <option value="beginner">Word</option>
                </select>
            </div>
          </div>
        </form>

        <div class="text-center">
            <button class="btn btn-primary" id="register-button">S'inscrire</button>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-primary" id="validate-button" style="visibility: hidden; height: 0;">Valider</button>
      </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    async function postData(url = "", data = {}) {
        const response = await fetch(url, {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
        return response.json();
    }

    window.onload = () => {
        window.onkeydown = (event) => {
            if (event.keyCode == 13) {
                event.preventDefault();
                return false;
            }
        };

        document.getElementById("register-button").onclick = () => {
            inputs = document.getElementById("first-step").getElementsByTagName("input")
            for (let i = 0; i < inputs.length; ++i) {
                if (inputs[i].value == null || inputs[i].value == "") {
                    alert("Remplissez tous les champs !")
                    return
                }
            }
            document.getElementById("first-step").style = "visibility: hidden; height: 0;"
            document.getElementById("register-button").style = "visibility: hidden; height: 0;"
            document.getElementById("second-step").style = ""
            document.getElementById("validate-button").style = ""
        }

        document.getElementById("validate-button").onclick = () => {
          let inputs = document.getElementById("second-step").getElementsByTagName("select")
          for (let i = 0; i < inputs.length; ++i) {
              if (inputs[i].value == null || inputs[i].value == "") {
                    alert("Remplissez tous les champs !")
                    return
              }
          }
          
          postData("/role", {posture: inputs[0].value, master: inputs[1].value, report: inputs[2].value}).then((data) => {
            console.log(data.role)
            form = document.createElement("form")
            form.method = "POST"; form.style = "visibility: hidden;"; document.body.append(form)
            input = document.createElement("input"); input.name = "role"; input.value = data.role; form.appendChild(input); 
            input = document.createElement("input"); input.name = "username"; input.value = document.getElementById("first-step").getElementsByTagName("input")[0].value; form.appendChild(input); 
            input = document.createElement("input"); input.name = "password"; input.value = document.getElementById("first-step").getElementsByTagName("input")[1].value; form.appendChild(input)
            form.submit()
          });

          // i shouldn't forget to fetch /me to retrieve the data later...
        }
    }
</script>


<!-- Ajoutez le script CDN de Bootstrap ci-dessous ou utilisez une version téléchargée localement -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
